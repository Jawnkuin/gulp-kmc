'use strict';
var through = require('through'),
    gutil = require('gulp-util'),
    PluginError = gutil.PluginError,
    fs = require('fs'),
    path = require('path'),
	kmd = require('k2cmd');


var depMap = {},
    realDepMap = {},
    writeTimer = null;

function writeDepFile(filePath){
    var code ="/*generated by KMD*/\nKISSY.config('modules'," + JSON.stringify(depMap,null,4) +');'
    fs.writeFile(filePath,code);
    fs.writeFile(filePath.replace(/\.js$/,"-min.js"),kmd.minify(code));
    gutil.log('combined dependency file ' + filePath + ' is created.');
}

module.exports ={
    config: kmd.config,
    cmd2k: function(opt) {
        var buffer = [];

	    function k2cmd(file) {
            /*jshint validthis:true */
            if (file.isNull()) {
                return;
            }

            if (file.isStream()) {
                return this.emit('error', new PluginError('gulp-kmc',  'Streaming not supported'));
            }

            var ignore = false;

            if(opt.exclude) {
                ignore = opt.exclude.some(function(item) {
                    return file.path.indexOf(item) > -1;
                });
            }

            if(ignore) {
                buffer.push(file);
                return;
            }


            var r = kmd.cmd2kissy2(file.contents.toString(), {
                                            filePath:file.path,
                                            fromFile:false,
                                            minify: opt.minify
                                        }),
                info = r.parser;

            if(info.depMods.length && !depMap[info.moduleName.moduleName]) {
                var requires = [],realRequires = [];
                info.depMods.forEach(function(dep) {
                    requires.push(dep.moduleName);
                    realRequires.push(dep.originalName);
                });
                realDepMap[info.moduleName.originalName] = { requires: realRequires };
                depMap[info.moduleName.moduleName] = { requires: requires };
            }

            if(opt.depFilePath) {
                if(writeTimer) {
                    clearTimeout(writeTimer);
                }
                writeTimer =setTimeout(function() {
                    writeDepFile(opt.depFilePath);
                },1000);
            }

            if(opt.minify) {
                var ext = opt.ext || "-min.js";
                var filePath = file.path.replace(/\.js$/, ext);

                buffer.push(new gutil.File({
                    contents:new Buffer(r.code.minifyCode),
                    path:filePath,
                    base:file.base
                }));
            }

            try {
                file.contents = new Buffer(r.code.wrappedCode);
            } catch (e) {
                return callback({
                    fileName: file.path,
                    lineNumber: e.line,
                    stack: e.stack,
                    showStack: false
                });
            }

            buffer.push(file);

        }

        function endStream() {
            if (buffer.length === 0) return this.emit('end');
            var self = this;
            buffer.forEach(function(file){
                self.push(file);
            });
            this.emit('end');
        }

	    return through(k2cmd, endStream);
    },

    combo: function(opt) {

       var combined = {},
           config = null;

       var buffer = [];

       function combo(_file, callback) {
            var combinedFile = [];

            if(combined[_file.path]) {
                return combinedFile;
            }

            if(opt && opt.files && opt.files.length) {
                opt.files.forEach(function(file){
                    if(path.resolve(file.src) == _file.path){
                       combined[_file.path] = {
                          files:[],
                          contents:[],
                          dest:file.dest
                       };
                       kmd.comboAsync(_file.path, callback);
                    }
                });
            }
       }

       function endStream() {
           if (buffer.length === 0) return this.emit('end');
           var self = this;

           var minifyFile = {};
           buffer.forEach(function(file){
               self.push(file);
               for(var f in combined){
                  var comboInfo = combined[f],
                      index = comboInfo.files.indexOf(file.path);

                  if(index > -1) {
                    if(opt.minify) {
                        var ext = opt.ext || "-min.js",
                            mPath = f.replace(/\.js$/,ext);

//                        if(!minifyFile[mPath]) {
//                            minifyFile[mPath] = {
//                                contents:[]
//                            }
//                        }

                        if(!comboInfo.minify) {
                            comboInfo.minify = [];
                        }
                    }

                     comboInfo.contents.push(file.contents);
                     comboInfo.files.splice(index,1);
                  }
               }
           });
           for(var f in combined){
               var comboInfo = combined[f];
               this.push(new gutil.File({
                    base:path.dirname(comboInfo.dest),
                    path:comboInfo.dest,
                    contents: new Buffer(comboInfo.contents.join("\n"))
               }));
           }

           this.emit('end');
       }

       return through(function (file) {
            if(!config) {
                kmd.config("modules",realDepMap);
                config = true;
            }
            if (file.isNull()) {
                this.push(file);
                return ;
            }

            if (file.isStream()) {
                return callback(uglifyError('Streaming not supported', {
                    fileName: file.path,
                    showStack: false
                }));
            }

            combo(file, function(mods){
                var files = [],
                    modsName= [];
                mods.forEach(function(mod){
                    //console.log(mod);
                    files.push(path.resolve(mod.url));
                    modsName.push(kmd.getMapModuleName(mod.name));
                });
                combined[file.path].files = files;
                combined[file.path].contents.push("/*\ncombined files by KMD:\n" + modsName.join("\n")+"\n*/\n");
            });
            buffer.push(file);

        },endStream);
    }
}